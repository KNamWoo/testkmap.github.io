<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=kf1tb4xvjj"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2c17c63895c70f99c88660a9321a9409&libraries=services"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <link rel="stylesheet" href="./index.css">
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <script src="./index.js"></script>
</head>
<body>
    <div id="search">
        <input id="search_input" placeholder="주소 검색" />
        <button id="search_button">검색</button>
    </div>

    <div id="map" class="mapcss"></div>

    <script>
        var container = document.getElementById('map');
        var options = {
            center: new naver.maps.LatLng(37.4720, 126.6608),
            level: 3
        };

        var map = new naver.maps.Map(container, options);

        let ps = new kakao.maps.services.Places();

        $("#search_input").on("keydown", function(e){
            if(e.keyCode === 13){//enter키
                let content = $(this).val();
                ps.keywordSearch(content, placeSearchCB);
            }
        })

        $("#search_button").on("click", function(e){
            let content = $("#search_input").val();
            ps.keywordSearch(content, placeSearchCB);
        })
    </script>

    <py-secret>
        # *-- Geocoding 활용 코드 --*
        import json
        import urllib
        from urllib.request import Request, urlopen
        # *-- 3개의 주소 geocoding으로 변환한다.(출발지, 도착지, 경유지) --*
        start = '서울특별시 종로구 청와대로 1'
        goal = '부산광역시 금정구 부산대학로63번길 2'
        waypoint = '경기도 수원시 장안구 서부로 2149'

        # 주소에 geocoding 적용하는 함수를 작성.
        def get_location(loc) :
            client_id = 'kf1tb4xvjj'
            client_secret = 'Gf5jTFUgJaOElLVWJXoCgJAancFO7n9nYvAqnKAe'
            url = f"https://naveropenapi.apigw.ntruss.com/map-geocode/v2/geocode?query=" \
                        + urllib.parse.quote(loc)
            
            # 주소 변환
            request = urllib.request.Request(url)
            request.add_header('X-NCP-APIGW-API-KEY-ID', client_id)
            request.add_header('X-NCP-APIGW-API-KEY', client_secret)
            
            response = urlopen(request)
            res = response.getcode()
            
            if (res == 200) : # 응답이 정상적으로 완료되면 200을 return한다
                response_body = response.read().decode('utf-8')
                response_body = json.loads(response_body)
                print(response_body)
                # 주소가 존재할 경우 total count == 1이 반환됨.
                if response_body['meta']['totalCount'] == 1 : 
                    # 위도, 경도 좌표를 받아와서 return해 줌.
                    lat = response_body['addresses'][0]['y']
                    lon = response_body['addresses'][0]['x']
                    return (lon, lat)
                else :
                    print('location not exist')
                
            else :
                print('ERROR')
                
        #  함수 적용
        start = get_location(start)
        goal = get_location(goal)
        waypoint = get_location(waypoint)


        # *-- Directions 5 활용 코드 --*
        option = ''
        # option : 탐색옵션 [최대 3개, traoptimal(기본 옵션) 
        # / trafast, tracomfort, traavoidtoll, traavoidcaronly]

        def get_optimal_route(start, goal, waypoints=waypoint, option=option ) :
            # waypoint는 최대 5개까지 입력 가능, 
            # 구분자로 |(pipe char) 사용하면 됨(x,y 좌표값으로 넣을 것)
            # waypoint 옵션을 다수 사용할 경우, 아래 함수 포맷을 바꿔서 사용 
            client_id = 'kf1tb4xvjj'
            client_secret = 'Gf5jTFUgJaOElLVWJXoCgJAancFO7n9nYvAqnKAe' 
            # start=/goal=/(waypoint=)/(option=) 순으로 request parameter 지정
            url = f"https://naveropenapi.apigw.ntruss.com/map-direction-15/v1/driving? \
            start={start[0]},{start[1]}&goal={goal[0]},{goal[1]}\
            &waypoints={waypoint[0]},{waypoint[1]}&option={option}"
            request = urllib.request.Request(url)
            request.add_header('X-NCP-APIGW-API-KEY-ID', client_id)
            request.add_header('X-NCP-APIGW-API-KEY', client_secret)
            
            response = urllib.request.urlopen(request)
            res = response.getcode()
            
            if (res == 200) :
                response_body = response.read().decode('utf-8')
                return json.loads(response_body)
                    
            else :
                print('ERROR')
                
        get_optimal_route(start, goal, option=option)

        

        # *-- 목적지까지의 종합 정보 추출(총 거리, 총 소요시간, 요금 등) --*
        message = {
            'message' : results['message'], # traoptimal은 option 에 따라 다르게 줄 것
            'option' : list(results['route'].keys())[0],
            'total_distance' : results['route']['traoptimal'][0]['summary']['distance'],
            'total_duration' : results['route']['traoptimal'][0]['summary']['duration'],
            'fares' : {'toll' : results['route']['traoptimal'][0]['summary']['tollFare'],
                    'taxi' : results['route']['traoptimal'][0]['summary']['taxiFare'],
                    'fuel' : results['route']['traoptimal'][0]['summary']['fuelPrice']}
        }
        print(message)

        # *-- 목적지까지의 guidence와 각각의 거리, 소요시간 정보 추출 --*
        temp = [ (guide['instructions'], guide['distance'] , guide['duration'] / 1000 ) \
        for guide in results['route']['traoptimal'][0]['guide'] ]

        print(temp)
    </py-secret>
</body>
</html>
